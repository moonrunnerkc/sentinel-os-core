<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel OS - Introspection Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; }
        #controls { padding: 1rem; background: #16213e; display: flex; gap: 1rem; align-items: center; }
        #controls input { padding: 0.5rem; border: 1px solid #444; background: #1a1a2e; color: #eee; }
        #controls button { padding: 0.5rem 1rem; background: #0f3460; border: none; color: #eee; cursor: pointer; }
        #controls button:hover { background: #1a5276; }
        #graph { width: 100%; height: calc(100vh - 60px); }
        .node { cursor: pointer; }
        .node circle { stroke: #fff; stroke-width: 2px; }
        .node text { font-size: 10px; fill: #eee; }
        .link { stroke: #555; stroke-opacity: 0.6; }
        .belief circle { fill: #3498db; }
        .goal circle { fill: #e74c3c; }
        #tooltip { position: absolute; background: #16213e; border: 1px solid #444; padding: 0.5rem; display: none; max-width: 300px; }
    </style>
</head>
<body>
    <div id="controls">
        <input type="file" id="fileInput" accept=".json">
        <button onclick="loadSample()">Load Sample</button>
        <span id="stats"></span>
    </div>
    <svg id="graph"></svg>
    <div id="tooltip"></div>

    <script>
        // Author: Bradley R. Kinnard
        // graph visualization for sentinel-os beliefs and goals

        let simulation, svg, g, link, node;
        const width = window.innerWidth;
        const height = window.innerHeight - 60;

        function init() {
            svg = d3.select("#graph")
                .attr("width", width)
                .attr("height", height);

            g = svg.append("g");

            svg.call(d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (e) => g.attr("transform", e.transform)));
        }

        function render(data) {
            g.selectAll("*").remove();

            const nodes = data.nodes || [];
            const links = data.edges || [];

            document.getElementById("stats").textContent =
                `Nodes: ${nodes.length} | Edges: ${links.length}`;

            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2));

            link = g.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .attr("stroke-width", d => Math.sqrt(d.weight || 1));

            node = g.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", d => `node ${d.type}`)
                .call(d3.drag()
                    .on("start", dragstart)
                    .on("drag", dragged)
                    .on("end", dragend));

            node.append("circle")
                .attr("r", d => 5 + (d.properties?.confidence || d.properties?.priority || 0.5) * 10);

            node.append("text")
                .attr("dx", 12)
                .attr("dy", 4)
                .text(d => d.label?.substring(0, 20) || d.id);

            node.on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        function dragstart(e, d) {
            if (!e.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
        }

        function dragged(e, d) { d.fx = e.x; d.fy = e.y; }

        function dragend(e, d) {
            if (!e.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
        }

        function showTooltip(e, d) {
            const tip = document.getElementById("tooltip");
            tip.innerHTML = `<strong>${d.id}</strong><br>Type: ${d.type}<br>${JSON.stringify(d.properties, null, 2)}`;
            tip.style.left = (e.pageX + 10) + "px";
            tip.style.top = (e.pageY + 10) + "px";
            tip.style.display = "block";
        }

        function hideTooltip() {
            document.getElementById("tooltip").style.display = "none";
        }

        function loadSample() {
            const sample = {
                nodes: [
                    {id: "b1", type: "belief", label: "The system is stable", properties: {confidence: 0.9}},
                    {id: "b2", type: "belief", label: "Memory is persistent", properties: {confidence: 0.85}},
                    {id: "g1", type: "goal", label: "Maintain stability", properties: {priority: 1.0}},
                    {id: "g2", type: "goal", label: "Optimize performance", properties: {priority: 0.7}}
                ],
                edges: [
                    {source: "b1", target: "g1", type: "supports", weight: 2},
                    {source: "b2", target: "g1", type: "supports", weight: 1.5},
                    {source: "g1", target: "g2", type: "parent-child", weight: 1}
                ]
            };
            render(sample);
        }

        document.getElementById("fileInput").addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    render(data);
                } catch (err) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(file);
        });

        init();
        loadSample();
    </script>
</body>
</html>
